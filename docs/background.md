# Background on the Whole Cell Model


## Important source code and data locations

### Knowledgebase/parameters
Files to generate the `sim_data` object that contains all parameters needed to run simulations.
* `reconstruction/ecoli/...`
    * `flat/`: raw data files
    * `dataclasses/`: classes for organizing data related to processes and states
    * `knowledge_base_raw.py`: script to load raw data
    * `simulation_data.py`: class of the `sim_data` object
    * `fit_sim_data_1.py`: script to calculate parameters from raw data to produce the `sim_data` object required for simulations

### Simulation/analysis
* `models/ecoli/...`
    * `processes/`: files to simulate physiological processes
    * `listeners/`: files to record data to disk during simulations
    * `analysis/`: files to analyze simulation output
    * `sim/variants/`: files that modify `sim_data` for running experiments on modified parameters
    * `sim/initial_conditions.py`: initializes cell states before simulation
    * `sim/simulation.py`: specifies classes that make an _E. coli_ simulation

### Utilities
General tools that are not _E. coli_ specific.
* `wholecell/...`
    * `fireworks/firetasks/`: handles inputs, outputs and options for the execution of tasks in a simulation workflow (eg. calculating parameters, running simulations, performing analysis)
    * `tests/`: test scripts to ensure proper functionality
    * `states/`: classes representing cell states used in simulations
    * `sim/simulation.py`: main simulation file handling states, processes, listeners and updates between them

### Validation data
This data will only be accessed during analysis and not during simulations.
* `validation/ecoli/...`
    * `flat/`: raw data files
    * `validation_data_raw.py`: script to load raw data
    * `validation_data.py`: script to process and organize raw data

### Cloud
* `cloud/...`
    * `docker/`: Dockerfiles for building Docker containers to run simulations
    * `build*.sh`: scripts to run Docker builds

### Runscripts
Scripts used as entry points for executing workflows, performing analysis or generating/cleaning data.
* `runscripts/...`
    * `reconstruction/`: scripts for processing data sources to `*.tsv` files in `reconstruction/ecoli/flat/`
    * `jenkins/`: scripts to test codebase through continuous integration (CI)
    * `manual/`: scripts for running portions of workflows interactively
    * `cloud/wcm.py`: used to make Docker fireworks workflows to run locally or on Google compute engine
    * `fireworks/fw_queue.py`: used to make fireworks workflows to run locally or on Sherlock

## Processes

Each _process_ models one part of the cell’s function, e.g. RNA polymerase elongation. They are modeled separately (modular), run in short time steps, and the results from each time step are integrated between processes before initiating the next time step. Other processes include translation, elongation, transciption, and metabolism.

Each process has three entry points:
* _initialize_: called only once at the beginning of a simulation. Get needed parameters from the knowledge base, get views of bulk and unique molecules (bulk molecules are “indistinguishable” from each other, e.g. inactive RNAP molecules, unique molecules can be distinguished from each other, e.g. active RNAP molecules are each assigned to a location on the genome), create a view so that you can get counts, change counts, and change properties.
* _calculateRequest_: called at the beginning of each timestep. Request the resources that you want for that timestep (don’t request all unless you are certain that another process doesn’t need this resource as well, don’t forget about metabolism).
* _evolveState_: called after resources are allocated at each timestep. Perform the process, update counts, and update masses (mass must be conserved between steps).


## Listeners

If you want to save new values to analyze after the simulation, you must write it out via a _listener_. Listeners log data during the simulation. To add a listener to the code, add the file to `wcEcoli/models/ecoli/listeners/` and add the listener to `_listenerClasses` in `wcEcoli/models/ecoli/sim/simulation.py`.


## States

### Bulk molecules

### Unique molecules

### Environment


## Analysis

Analysis plots will use sim_data generated by the parca, data from sims stored in listeners and can compare to validation data withheld from simulations.  See [models/ecoli/analysis/](https://github.com/CovertLab/wcEcoli/tree/master/models/ecoli/analysis) for all the analysis scripts.

TODO: add schematic to show groupings for single/multigen/cohort/variant analysis

### Single
Analysis to be performed on a single simulation (for each variant, seed, generation and daughter).  This is typically detailed information about each sim.

### Multigen
Analysis to be performed on multiple generations starting with a single parent (for each variant and seed).  This is typically to see trends and evolution over time/many generations.

### Cohort
Analysis to be performed across multiple generations that were initialized with a different random seed (for each variant).  This is typically to see variability from initial conditions and stochastic events.

### Variant
Analysis to be performed on all sims run together in order to compare effects from sim_data modifications (only run for the entire set of sims).  Each analysis script is typically created for a specific simulation variant to show the output differences from using different parameter values.

### Causality network
Create data series for interactive exploration of data through the Fathom [visualization tool](https://github.com/CovertLab/causality).

After generating data series, display the data by running the following command from the cloned repo with the proper path for your simulation output:
```
python site/server.py ~/wcEcoli/out/manual/kb ~/wcEcoli/out/manual/wildtype_000000/000000/generation_000000/000000/seriesOut
```

Useful network topologies can be saved in [models/ecoli/analysis/causality_network/saved_networks](https://github.com/CovertLab/wcEcoli/tree/master/models/ecoli/analysis/causality_network/saved_networks) and loaded through the web interface after running the `python site/server.py ...` command above.

## Adding to the codebase
### New raw data

### New process

### New variant

### New listener

### New analysis


## Design factors

* One implicit modeling design goal is that no phenomena be modeled in more than one place over a given time interval -- exactly one place, if the model is complete.

* We have to be careful about degrees of representation. E.g. genes with known differential expression but no associated transcription factor do not currently change their expression during an environmental shift.

* A reproducible/testable way to show what is or isn't represented is via validation against some expected behavior or withheld data set.
