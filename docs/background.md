# Background on the Whole Cell Model


## Important source code and data locations

### Knowledgebase/parameters
Files to generate the `sim_data` object that contains all parameters needed to run simulations.
* `reconstruction/ecoli/...`
    * `flat/`: raw data files
    * `dataclasses/`: classes for organizing data related to processes and states
    * `knowledge_base_raw.py`: script to load raw data
    * `simulation_data.py`: class of the `sim_data` object
    * `fit_sim_data_1.py`: script to calculate parameters from raw data to produce the `sim_data` object required for simulations

### Simulation/analysis
* `models/ecoli/...`
    * `processes/`: files to simulate physiological processes
    * `listeners/`: files to record data to disk during simulations
    * `analysis/`: files to analyze simulation output
    * `sim/variants/`: files that modify `sim_data` for running experiments on modified parameters
    * `sim/initial_conditions.py`: initializes cell states before simulation
    * `sim/simulation.py`: specifies classes that make an _E. coli_ simulation

### Utilities
General tools that are not _E. coli_ specific.
* `wholecell/...`
    * `fireworks/firetasks/`: handles inputs, outputs and options for the execution of tasks in a simulation workflow (eg. calculating parameters, running simulations, performing analysis)
    * `tests/`: test scripts to ensure proper functionality
    * `states/`: classes representing cell states used in simulations
    * `sim/simulation.py`: main simulation file handling states, processes, listeners and updates between them

### Validation data
This data will only be accessed during analysis and not during simulations.
* `validation/ecoli/...`
    * `flat/`: raw data files
    * `validation_data_raw.py`: script to load raw data
    * `validation_data.py`: script to process and organize raw data

### Cloud
* `cloud/...`
    * `docker/`: Dockerfiles for building Docker containers to run simulations
    * `build*.sh`: scripts to run Docker builds

### Runscripts
Scripts used as entry points for executing workflows, performing analysis or generating/cleaning data.
* `runscripts/...`
    * `reconstruction/`: scripts for processing data sources to `*.tsv` files in `reconstruction/ecoli/flat/`
    * `jenkins/`: scripts to test codebase through continuous integration (CI)
    * `manual/`: scripts for running portions of workflows interactively
    * `cloud/wcm.py`: used to make Docker fireworks workflows to run locally or on Google compute engine
    * `fireworks/fw_queue.py`: used to make fireworks workflows to run locally or on Sherlock

## Processes

Each _process_ models one part of the cell’s function, e.g. RNA polymerase elongation. They are modeled separately (modular), run in short time steps, and the results from each time step are integrated between processes before initiating the next time step. Other processes include translation, elongation, transciption, and metabolism.

Each process has three entry points:
* _initialize_: called only once at the beginning of a simulation. Get needed parameters from the knowledge base, get views of bulk and unique molecules (bulk molecules are “indistinguishable” from each other, e.g. inactive RNAP molecules, unique molecules can be distinguished from each other, e.g. active RNAP molecules are each assigned to a location on the genome), create a view so that you can get counts, change counts, and change properties.
* _calculateRequest_: called at the beginning of each timestep. Request the resources that you want for that timestep (don’t request all unless you are certain that another process doesn’t need this resource as well, don’t forget about metabolism).
* _evolveState_: called after resources are allocated at each timestep. Perform the process, update counts, and update masses (mass must be conserved between steps).


## Listeners

If you want to save new values to analyze after the simulation, you must write it out via a _listener_. Listeners log data during the simulation. To add a listener to the code, add the file to `wcEcoli/models/ecoli/listeners/` and add the listener to `_listenerClasses` in `wcEcoli/models/ecoli/sim/simulation.py`.


## States

### Bulk molecules

### Unique molecules

### Environment


## Analysis

Analysis plots will use sim_data generated by the parca, data from sims stored in listeners and can compare to validation data withheld from simulations.  See [models/ecoli/analysis/](https://github.com/CovertLab/wcEcoli/tree/master/models/ecoli/analysis) for all the analysis scripts.

TODO: add schematic to show groupings for single/multigen/cohort/variant analysis

### Single
Analysis to be performed on a single simulation (for each variant, seed, generation and daughter).  This is typically detailed information about each sim.

### Multigen
Analysis to be performed on multiple generations starting with a single parent (for each variant and seed).  This is typically to see trends and evolution over time/many generations.

### Cohort
Analysis to be performed across multiple generations that were initialized with a different random seed (for each variant).  This is typically to see variability from initial conditions and stochastic events.

### Variant
Analysis to be performed on all sims run together in order to compare effects from sim_data modifications (only run for the entire set of sims).  Each analysis script is typically created for a specific simulation variant to show the output differences from using different parameter values.

### Causality network
Create data series for interactive exploration of data through the Fathom [visualization tool](https://github.com/CovertLab/causality).

After generating data series, display the data by running the following command from the cloned repo with the proper path for your simulation output:
```
python site/server.py ~/wcEcoli/out/manual/kb ~/wcEcoli/out/manual/wildtype_000000/000000/generation_000000/000000/seriesOut
```

Alternatively, you can set your environment variable `$CAUSALITY_SERVER` as the path to `site/server.py` in the Causality repo (TIP: add this to your `.bash_profile`) and run the manual runscript with the `--show` flag from this repo to automatically display the data generated and allow for easier selection of specific seeds/generations etc:
```
export CAUSALITY_SERVER="~/path/to/causality/site/server.py"
python runscripts/manual/buildCausalityNetwork.py --show
```

Useful network topologies can be saved in [models/ecoli/analysis/causality_network/saved_networks](https://github.com/CovertLab/wcEcoli/tree/master/models/ecoli/analysis/causality_network/saved_networks) and loaded through the web interface after running the `python site/server.py ...` command above.

### Parca
Analysis to be performed on `raw_data`, `sim_data` and `validation_data` only.  This does not require any simulation output and is only run once after the parca has run to visualize raw data and processed data.

## Adding to the codebase
### New raw data
Raw data should always be annotated with the source and process used to generate it for reproducibility.  The best way is to include it in the file as noted below and described in the PR that incorporates the data into the repo.  Adding several data files and scripts to a runscript directory could also use a README.md if desired to point to sources and describe how to run the scripts/what output to expect.
1. Add a raw data file to [reconstruction/ecoli/flat/](https://github.com/CovertLab/wcEcoli/tree/master/reconstruction/ecoli/flat). Data is stored in a `.tsv` file format with special formatting handling to allow units (specified in parantheses in column headers), lists, dictionaries and comments (lines starting with `#`).
1. Annotate where the data came from in a comment at the top of the file (URL for the data source and/or script used for processing original data - [see example](https://github.com/CovertLab/wcEcoli/blob/master/reconstruction/ecoli/flat/metabolism_kinetics.tsv)). If a script was required, add it to [runscripts/reconstruction](https://github.com/CovertLab/wcEcoli/tree/master/runscripts/reconstruction).
1. Add the filename to `LIST_OF_DICT_FILENAMES` in [knowledge_base_raw.py](https://github.com/CovertLab/wcEcoli/blob/master/reconstruction/ecoli/knowledge_base_raw.py). This will cause the data to be loaded into the class when an instance of `KnowledgeBaseEcoli` is created.
1. Access the data in the appropriate reconstruction class (eg [processes](https://github.com/CovertLab/wcEcoli/tree/master/reconstruction/ecoli/dataclasses/process) or [states](https://github.com/CovertLab/wcEcoli/tree/master/reconstruction/ecoli/dataclasses/state)) by accessing the `raw_data` attribute (eg. `raw_data.new_file` for a file named `new_file.tsv`)

**NOTE:** if there are issues loading the new file, try saving it using `JsonWriter` from [reconstruction/spreadsheets.py](https://github.com/CovertLab/wcEcoli/blob/master/reconstruction/spreadsheets.py) to ensure proper formatting:
```python
from reconstruction.spreadsheets import JsonWriter

headers = ['a', 'b']
with open('output.tsv', 'w') as f:
    writer = JsonWriter(f, headers)
    writer.writeheader()
    writer.writerow({'a': 1, 'b': 2})  # write as many rows of data as needed
```

### New validation data

### New process

### New variant


### New listener

### New analysis
This outlines how to add a new single analysis plot called `new_analysis.py`.  For other types of analysis, only the directory needs to be changed.  New analysis plots might require additional simulation data to be saved to disk by adding entries to an existing listener or creating a new listener (see 'New listener' section above).
1. Decide which level of analysis is appropriate (single, multigen, cohort, variant - see 'Analysis' section above for differences between each).
1. Create a new file by copying  the `template.py` file in the directory for desired analysis type (single, multigen, cohort, variant) in [models/ecoli/analysis/](https://github.com/CovertLab/wcEcoli/tree/master/models/ecoli/analysis).
    ```
    cp models/ecoli/analysis/single/template.py models/ecoli/analysis/single/new_analysis.py
    ```
1. Add the new plot (`"new_analysis.py"`) to the desired lists in `__init__.py` in the appropriate analysis directory (eg [for single analysis](https://github.com/CovertLab/wcEcoli/blob/master/models/ecoli/analysis/single/__init__.py)).
    - Always add to `ACTIVE` so that continuous integration tests the new plot
    - If desired, add to `CORE` to run with default analysis if the new analysis is useful in most simulation circumstances
    - If desired, add to other lists in `TAGS` to run with groups of plots for more specific analysis (eg. `METABOLISM`, `TRANSCRIPTION`, `TRANSLATION`, etc.) when using the manual scripts with the `-p` flag.  For example, to run all plots in the METABOLISM tag for a sim in out/manual:
        ```
        python runscripts/manual/analysisSingle.py out/manual -p METABOLISM
        ```


## Design factors

* One implicit modeling design goal is that no phenomena be modeled in more than one place over a given time interval -- exactly one place, if the model is complete.

* We have to be careful about degrees of representation. E.g. genes with known differential expression but no associated transcription factor do not currently change their expression during an environmental shift.

* A reproducible/testable way to show what is or isn't represented is via validation against some expected behavior or withheld data set.
